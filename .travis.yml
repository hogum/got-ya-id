language: rust
sudo: required
rust:
    - nightly

cache:
    cargo: true
before_cache: rm -rf "$TRAVIS_HOME/.cargo/registry/src" 

env:
    global:
        - RUST_BACKTRACE=1

        - db_username='postgres'
        - db_port=5432
        - db_host='localhost'
        - db_pass='poshy'
        - db_name='gotdb'
        - test_db_name='gotdb_test'

        - DATABASE_URL=postgres://$db_username:$db_pass@$db_host:$db_port/$db_name
        - TEST_DATABASE_URL=postgres://$db_username:$db_pass@$db_host:$db_port/$test_db_name

install:
    - cargo install diesel_cli --vers 1.4.0 --no-default-features --features postgres
    - sudo systemctl restart postgresql@11-main
    - sudo apt install python3-dev python-dev

addons:
    postgresql: "11"
    apt:
        packages:
            - postgresql-11
            - postgresql-client-11
            - postgresql-11-postgis-3

before_script:
  - psql -U postgres -c "create extension postgis"
  - psql -c 'create database gotdb;' -U postgres
  - psql -c 'create database gotdb_test;' -U postgres
  - psql -c "alter user postgres with password 'poshy'"; 
  - diesel database setup --locked-schema --migration-dir=src/diesel_cfg/migrations/

scipt:
    - cargo test

notifications:
  email:
    on_success: never
